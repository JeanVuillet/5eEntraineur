<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Quiz ‚Äì Les deux empires</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(#e0f2fe, #f8fafc);
      color: #222;
      max-width: 860px;
      margin: 40px auto;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      position: relative;
      overflow: hidden;
    }
    h1, h2 { text-align: center; margin: 5px 0 10px; }
    h2 { color: #374151; }

    #mainProgress {
      background-color: #e5e7eb;
      border-radius: 14px;
      overflow: hidden;
      height: 26px;
      margin-bottom: 10px;
      box-shadow: inset 0 0 4px rgba(0,0,0,0.12);
    }
    #mainBar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg,#22c55e,#16a34a);
      transition: width 0.4s ease;
    }

    #subBars { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 20px; margin-bottom: 12px; }
    .subProgress { background-color: #e5e7eb; border-radius: 10px; height: 18px; overflow: hidden; position: relative; }
    .subBar { height: 100%; width: 0%; background: linear-gradient(90deg,#60a5fa,#2563eb); transition: width 0.4s ease; }
    .subLabel { position: absolute; top: 0; left: 8px; font-size: 0.85em; color: #fff; text-shadow: 0 0 3px rgba(0,0,0,0.5); line-height: 18px; font-weight: 600; }

    #question { font-size: 1.2em; margin: 18px 0 8px; text-align: center; }
    #feedback { margin-top: 10px; font-weight: 700; text-align: center; }
    #choices { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px auto; max-width: 600px; }
    .choice {
      border: 1px solid #d1d5db; border-radius: 10px; padding: 10px; cursor: pointer;
      background: #fff; text-align: center; transition: transform .1s, box-shadow .2s;
    }
    .choice:hover { box-shadow: 0 5px 10px rgba(0,0,0,0.08); transform: translateY(-2px); }
    .choice.correct { background: #dcfce7; border-color: #22c55e; }
    .choice.wrong { background: #fee2e2; border-color: #ef4444; }

    #freeInputZone { display: none; text-align: center; margin-top: 10px; }
    #answer { padding: 8px; width: 70%; font-size: 1em; }
    #submit { margin-top: 10px; padding: 10px 14px; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer; }
    #submit:hover { background: #16a34a; }

    /* === ARENE === */
    #arena {
      position: relative;
      height: 240px;
      margin-top: 30px;
      background: linear-gradient(#f0f9ff, #e0f2fe);
      border-radius: 12px;
      overflow: hidden;
    }
    #hero, #zombie, #projectile {
      position: absolute;
      bottom: 0;
      height: 180px;
      image-rendering: pixelated;
    }
    #hero { left: 20px; }
    #zombie { right: 20px; transition: right 0.1s linear; }
    #projectile {
      width: 40px;
      height: 40px;
      background: radial-gradient(circle, #38bdf8 0%, #0284c7 80%);
      border-radius: 50%;
      display: none;
    }
  </style>
</head>
<body>

<h1>Les deux empires üè∞</h1>
<h2 id="levelTitle">Niveau 1 : rep√®res</h2>

<div id="mainProgress"><div id="mainBar"></div></div>
<p id="general" class="muted" style="text-align:center;">Compteur g√©n√©ral : 0/0</p>

<div id="subBars"></div>
<p id="question"></p>

<div id="choices"></div>

<div id="freeInputZone">
  <input type="text" id="answer" placeholder="√âcris ta r√©ponse ici">
  <br>
  <button id="submit">Valider</button>
</div>

<p id="feedback"></p>

<!-- Zone ar√®ne -->
<div id="arena">
  <img id="hero" src="img/hero.png" alt="H√©ros">
  <img id="zombie" src="img/zombi.png" alt="Zombie">
  <div id="projectile"></div>
</div>

<script>
const levels = [
  {
    title: "Niveau 1 : rep√®res",
    placeholder: "√âcris la r√©ponse (dernier palier)",
    requiredPerQuestion: 3,
    startScore: 0,
    wrongPenaltyInput: 1,
    questions: [
      { q: "Quel empire se trouve √† l‚ÄôOuest de l‚ÄôEurope au d√©but du Moyen √Çge ?", a: "carolingien", options: ["carolingien","byzantin","ottoman","romain d'orient"] },
      { q: "Quel empire se trouve √† l‚ÄôEst de l‚ÄôEurope, centr√© sur Constantinople ?", a: "byzantin", options: ["byzantin","carolingien","ottoman","sassanide"] },
      { q: "Quelle est la capitale de l‚ÄôEmpire carolingien ?", a: "Aix-la-Chapelle", acceptable: ["aix la chapelle","aix-la-chapelle","aix la Chapelle"], options: ["Aix-la-Chapelle","Aixe-la-chapelle","Rome","Constantinople"] },
      { q: "Quelle est la capitale de l‚ÄôEmpire byzantin ?", a: "Constantinople", options: ["Constantinople","Aix-la-chapelle","Aix-en-provence","Rome"] },
      { q: "Religion dominante dans l‚ÄôEmpire carolingien ?", a: "catholique", options: ["catholique","orthodoxe","islam","arianisme"] },
      { q: "Religion dominante dans l‚ÄôEmpire byzantin ?", a: "orthodoxe", options: ["orthodoxe","catholique","islam","arianisme"] }
    ]
  }
];

let currentLevel = 0;
let localScores = [];
let general = 0;
let currentIndex = -1;
let locked = false;
let zombieInterval = null;
let zombiePosition = 20; // en pixels depuis la droite
let projectileInterval = null;

const mainBar = document.getElementById("mainBar");
const subBarsContainer = document.getElementById("subBars");
const generalText = document.getElementById("general");
const qElt = document.getElementById("question");
const feedback = document.getElementById("feedback");
const choicesZone = document.getElementById("choices");
const freeInputZone = document.getElementById("freeInputZone");
const inputElt = document.getElementById("answer");
const submitBtn = document.getElementById("submit");
const zombieElt = document.getElementById("zombie");
const projectileElt = document.getElementById("projectile");

function setupLevel(idx) {
  const lvl = levels[idx];
  localScores = new Array(lvl.questions.length).fill(lvl.startScore);
  general = 0; currentIndex = -1;
  subBarsContainer.innerHTML = "";
  lvl.questions.forEach((_,i)=>{
    const bar=document.createElement("div");
    bar.className="subProgress";
    bar.innerHTML=`<div class="subBar" id="subBar${i}"></div><div class="subLabel">${i+1}</div>`;
    subBarsContainer.appendChild(bar);
  });
  updateBars();
  nextQuestion();
}

function updateBars(){
  const lvl=levels[currentLevel];
  const total=lvl.questions.length;
  mainBar.style.width=(general/total)*100+"%";
  generalText.textContent=`Compteur g√©n√©ral : ${general}/${total}`;
  const req=lvl.requiredPerQuestion;
  lvl.questions.forEach((_,i)=>{
    const bar=document.getElementById("subBar"+i);
    const val=Math.max(0,Math.min(localScores[i],req));
    bar.style.width=(val/req)*100+"%";
  });
}

function nextQuestion(){
  clearInterval(zombieInterval);
  zombiePosition = 20;
  zombieElt.style.right = zombiePosition + "px";
  zombieElt.style.display = "block";
  locked=false;
  const lvl=levels[currentLevel];
  if (general>=lvl.questions.length){
    qElt.textContent="üéâ Bravo ! Niveau termin√© !";
    choicesZone.innerHTML=""; freeInputZone.style.display="none";
    feedback.textContent="";
    return;
  }
  const nxt=findNextIndex(currentIndex);
  currentIndex=nxt;
  renderQuestion();
  startZombie();
}

function findNextIndex(fromIdx){
  const lvl=levels[currentLevel];
  const req=lvl.requiredPerQuestion;
  const n=lvl.questions.length;
  for(let i=fromIdx+1;i<n;i++) if(localScores[i]<req) return i;
  for(let i=0;i<=fromIdx;i++) if(localScores[i]<req) return i;
  return null;
}

function renderQuestion(){
  const lvl=levels[currentLevel];
  const q=lvl.questions[currentIndex];
  const progress=localScores[currentIndex];
  qElt.textContent=q.q;
  feedback.textContent="";
  inputElt.value="";
  if(progress>=lvl.requiredPerQuestion-1){
    choicesZone.innerHTML="";
    freeInputZone.style.display="block";
  } else {
    freeInputZone.style.display="none";
    renderChoices(q);
  }
}

function renderChoices(q){
  const shuffled=[...q.options].sort(()=>Math.random()-0.5);
  choicesZone.innerHTML="";
  shuffled.forEach(opt=>{
    const c=document.createElement("div");
    c.className="choice";
    c.textContent=opt;
    c.addEventListener("click",()=>onChoiceClick(c,opt,q));
    choicesZone.appendChild(c);
  });
}

function normalize(txt){return (txt||"").toLowerCase().trim();}
function isCorrectFreeInput(q,txt){
  txt=normalize(txt);
  if(q.acceptable) return q.acceptable.some(v=>txt===normalize(v));
  return txt.includes(normalize(q.a));
}
function isCorrectOption(opt,q){return normalize(opt)===normalize(q.a);}

function onChoiceClick(elt,opt,q){
  if(locked)return;
  const ok=isCorrectOption(opt,q);
  locked=true;
  if(ok){
    elt.classList.add("correct");
    feedback.textContent="‚úÖ Bonne r√©ponse !";
    attack();
    incrementProgress(1);
    setTimeout(nextQuestion,1200);
  } else {
    elt.classList.add("wrong");
    feedback.textContent=`‚ùå Mauvaise r√©ponse. Bonne r√©ponse : ${q.a}`;
    setTimeout(nextQuestion,2500);
  }
}

submitBtn.addEventListener("click",()=>{
  if(locked)return;
  const q=levels[currentLevel].questions[currentIndex];
  const ok=isCorrectFreeInput(q,inputElt.value);
  locked=true;
  if(ok){
    feedback.textContent="‚úÖ Bonne r√©ponse !";
    attack();
    incrementProgress(1,true);
    setTimeout(nextQuestion,1200);
  } else {
    localScores[currentIndex]=Math.max(0,localScores[currentIndex]-1);
    feedback.textContent=`‚ùå Mauvaise r√©ponse. Bonne r√©ponse : ${q.a}`;
    updateBars();
    setTimeout(nextQuestion,2500);
  }
});

function incrementProgress(v,final=false){
  const req=levels[currentLevel].requiredPerQuestion;
  localScores[currentIndex]=Math.min(req,localScores[currentIndex]+v);
  if(final||localScores[currentIndex]===req)general++;
  updateBars();
}

/* === ZOMBIE & HERO ANIMATION === */
function startZombie(){
  clearInterval(zombieInterval);
  zombieInterval=setInterval(()=>{
    zombiePosition+=0.7; // üßü vitesse ralentie √∑3
    zombieElt.style.right=zombiePosition+"px";
    if(zombiePosition>600){
      clearInterval(zombieInterval);
      feedback.textContent="üíÄ Le zombie t‚Äôa attrap√© ! Question suivante...";
      setTimeout(nextQuestion,2000);
    }
  },50);
}

function attack(){
  const proj=projectileElt;
  proj.style.display="block";
  proj.style.left="100px";
  proj.style.bottom="100px";
  let pos=100;
  clearInterval(projectileInterval);
  projectileInterval=setInterval(()=>{
    pos+=25;
    proj.style.left=pos+"px";
    const projRect = proj.getBoundingClientRect();
    const zombRect = zombieElt.getBoundingClientRect();
    if (projRect.right >= zombRect.left + 10) {
      // üí• collision d√©tect√©e
      clearInterval(projectileInterval);
      proj.style.display="none";
      zombieElt.style.display="none";
      setTimeout(()=>{zombieElt.style.display="block"; zombiePosition=20; zombieElt.style.right="20px";},600);
    }
    if(pos>700){
      clearInterval(projectileInterval);
      proj.style.display="none";
    }
  },50);
}

setupLevel(0);
</script>
</body>
</html>
